<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <base href="/">
    <link rel="stylesheet" href="bower_components/angular-material/angular-material.css">
    <link rel="stylesheet" href="bower_components/peach.css/dist/peach.css">

    <!-- build:css({.tmp/app/serve,client/app}) styles/app.css -->
    <!-- inject:css -->
    <!-- css files will be automatically insert here -->
    <!-- endinject -->
    <!-- endbuild -->
  </head>
  <body layout="column" ng-app="peachWebLogin" ng-strict-di ng-controller="LoginController as login">

    <div layout="column" layout-fill>
      <md-content layout="column" layout-fill flex>
        <div class="peach-login" flex layout="column">
          <div class="login-body" layout="row" layout layout-align="center center" flex>
            <div layout="column" flex>
              <md-whiteframe class="login-container md-whiteframe-z1">
                <form name="loginForm" ng-submit="login.submit(loginForm.$valid, data)">
                  <img class="logo" src="assets/img/logo/logo_color_2x.png" alt="PeachWorks"/>
                  <div ng-show="login.loginError" class="form-error-container">
                    <p class="form-error" ng-bind="login.loginError"></p>
                  </div>
                  <md-input-container>
                    <label>Email
                      <span ng-if="loginForm.email.$touched">
                        <span ng-if="loginForm.$error.email">Address: Must be in valid format</span>
                      </span>
                    </label>
                    <input name="email" ng-model="data.email" required type="email" aria-label="Email">
                  </md-input-container>
                  <md-input-container>
                    <label>Password</label>
                    <input name="password" ng-model="data.password" required type="password" aria-label="Password">
                  </md-input-container>
                  <div flex layout="row">
                    <div flex="55" layout="column">
                      <md-input-container class="checkbox-container">
                        <md-checkbox ng-model="data.remember" aria-label="Stay Logged In">Stay Logged In</md-checkbox>
                      </md-input-container>
                    </div>
                    <div flex layout="column">
                      <md-input-container>
                        <md-button class="md-raised md-primary" aria-label="Login">
                          <span ng-if="!login.loading">Login</span>
                          <md-progress-circular ng-if="login.loading" md-diameter="24" md-mode="indeterminate"></md-progress-circular>
                        </md-button>
                      </md-input-container>
                    </div>
                  </div>
                </form>
              </md-whiteframe>
            </div>
          </div>
          <div class="login-footer" layout="row" layout-align="center center">
            <p><a href="#/forgotpw">Help: I'm having trouble signing in or forgot my password</a></p>
          </div>
        </div>
      </md-content>
    </div>

    <script src="bower_components/angular/angular.js"></script>
    <script src="bower_components/angular-animate/angular-animate.js"></script>
    <script src="bower_components/angular-aria/angular-aria.js"></script>
    <script src="bower_components/angular-cookies/angular-cookies.js"></script>
    <script src="bower_components/angular-touch/angular-touch.js"></script>
    <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="bower_components/angular-route/angular-route.js"></script>
    <script src="bower_components/angular-material/angular-material.js"></script>
    <script src="bower_components/angular-cache/dist/angular-cache.js"></script>
    <script src="bower_components/lodash/lodash.js"></script>
    <script src="bower_components/ng-peach/dist/peach.js"></script>

    <script>
      (function() {
        angular.module('peachWebLogin', [
          'ngAnimate',
          'ngAria',
          'ngCookies',
          'ngTouch',
          'ngSanitize',
          'ngRoute',
          'ngMaterial',
          'ngPeach.ui'
        ])
          .controller('LoginController', ['$peach', '$q', '$window', '$cookies', LoginController]);

        function LoginController($peach, $q, $window, $cookies) {
          var vm = this;

          vm.submit = submit;

          if($cookies[$peach.session.getDevSessionCookieName()]) {
            bootstrap();
          }

          function submit(valid, data) {
            if(valid && !_.isEmpty(data)) {
              $peach.session.login(data.email, data.password).then(function(message) {
                bootstrap();

                return true;
              }, function(error) {
                this.loginError = error;
              });
            } else {
              return false;
            }
          }

          function bootstrap() {
            var promises = [];
            promises.push($peach.user.getInfo());
            //promises.push($peach.user.getAccounts()); // get v1/developers

            $q.all(promises).then(function(data) {
              return $window.location.href = '/accounts/1/apps/appKey/#/';
            });
          }
        }

      })();
    </script>

    <script>
  		angular.module('peachWebLogin').run(['$peach', function($peach) {
  			$peach.session.setOptions({
  				apiURL: 'https://api.dev.peachworks.com',
  				apiVersion: 'v1'
  			});
  		}]);
  	</script>
  </body>
</html>
